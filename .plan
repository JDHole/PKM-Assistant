# Plan: Sekcja 2.8.5 â€” Input Chatu v2 (Web Search + @ Mentions + ZaÅ‚Ä…czniki + ask_user)

> Nowa sekcja w PLAN_v2.md, miÄ™dzy 2.8 (Skills v2) a 2.9 (PamiÄ™Ä‡).
> Szacunek: 4-5 sesji. Priorytet: WYSOKI (core features brakujÄ…ce w pluginie).

---

## Co robimy (4 duÅ¼e rzeczy)

### A. Web Search Tool â€” agent szuka w necie
### B. ask_user Tool â€” agent pyta usera i CZEKA na odpowiedÅº (inline w chacie)
### C. @ Mentions â€” @notatka i @folder: w chacie
### D. ZaÅ‚Ä…czniki â€” obrazki, pliki tekstowe, PDF (drag & drop, paste, przycisk)

---

## FAZA A: Web Search Tool (sesja ~1)

### A1. Nowy plik: `src/mcp/WebSearchTool.js`
- NarzÄ™dzie MCP jak kaÅ¼de inne (name, description, inputSchema, execute)
- inputSchema: `{ query: string, limit?: number }` (limit = ile wynikÃ³w, default 5)
- execute():
  1. Pobiera provider z ustawieÅ„ pluginu (domyÅ›lnie Jina AI)
  2. WywoÅ‚uje `requestUrl()` z Obsidian API (omija CORS)
  3. Parsuje wyniki â†’ zwraca `{ success, query, results: [{title, url, content}] }`

### A2. Multi-provider architecture w `src/core/WebSearchProvider.js`
- Klasa bazowa z metodÄ… `search(query, limit)`
- Implementacje:
  - **JinaProvider** (default): `https://s.jina.ai/?q=...` â€” dziaÅ‚a BEZ klucza API
  - **TavilyProvider**: `https://api.tavily.com/search` â€” wymaga klucza
  - **BraveProvider**: `https://api.search.brave.com/res/v1/web/search` â€” wymaga klucza
  - **SearXNGProvider**: `${userUrl}/search?q=...&format=json` â€” user podaje URL
- Fabryka: `createProvider(settings)` â†’ zwraca odpowiedni provider na podstawie ustawieÅ„

### A3. Ustawienia w UI
- Nowa sekcja "Web Search" w ustawieniach pluginu
- Dropdown: provider (Jina AI / Tavily / Brave / Serper / SearXNG)
- Pole na klucz API (widoczne tylko gdy provider tego wymaga)
- Pole na URL SearXNG (widoczne tylko gdy SearXNG wybrany)
- Link/guzik "ZaÅ‚Ã³Å¼ darmowe konto" przekierowujÄ…cy na stronÄ™ providera
- Toggle: "Web Search wÅ‚Ä…czony" (globalnie)

### A4. Rejestracja + filtrowanie
- Rejestracja w main.js (tak jak pozostaÅ‚e 21 narzÄ™dzi)
- Dodanie do TOOL_INFO w ToolCallDisplay.js: `{ icon: 'ğŸŒ', label: 'Wyszukiwanie w internecie' }`
- Dodanie do ACTION_TYPE_MAP w MCPClient.js â†’ nowy typ: `web.search`
- requiresApproval: TAK (chyba Å¼e YOLO mode)
- Dodanie do WorkMode.js â€” dostÄ™pne we wszystkich trybach
- Dodanie do Decision Tree: nowa instrukcja w grupie `szukanie` â€” "Gdy potrzebujesz aktualnych informacji z internetu, uÅ¼yj web_search"

### A5. Approval inline w chacie (nie modal Obsidiana!)
- Zamiast ApprovalModal (ktÃ³ry wyskakuje jako popup) â†’ renderujemy blok approval WEWNÄ„TRZ chatu
- WyglÄ…da jak kolejna czÄ™Å›Ä‡ odpowiedzi agenta:
  ```
  ğŸŒ Agent chce wyszukaÄ‡ w internecie:
  "Obsidian 2.0 nowe funkcje 2026"

  [Szukaj]  [Anuluj]
  ```
- Klik "Szukaj" â†’ kontynuuje wykonanie narzÄ™dzia
- Klik "Anuluj" â†’ zwraca agentowi info o odmowie
- YOLO mode â†’ blok siÄ™ nie pojawia, leci automatycznie
- UWAGA: To jest zmiana TYLKO dla web_search na razie. Reszta narzÄ™dzi dalej uÅ¼ywa ApprovalModal. Ujednolicenie approval flow to temat na 2.10 (UX Chatu).

### A6. Renderowanie wynikÃ³w w chacie
- Blok tool call jak inne narzÄ™dzia (zwijany)
- Ale z Å‚adniejszym formatem: lista wynikÃ³w z tytuÅ‚ami, linkami, fragmentami
- Link klikalny (otwiera w przeglÄ…darce)

### Pliki do stworzenia/zmiany (Faza A):
- NOWY: `src/mcp/WebSearchTool.js` (~80 LOC)
- NOWY: `src/core/WebSearchProvider.js` (~150 LOC â€” bazowa + 4 providery)
- ZMIANA: `src/main.js` â€” rejestracja narzÄ™dzia + ustawienia UI
- ZMIANA: `src/components/ToolCallDisplay.js` â€” TOOL_INFO + custom renderowanie wynikÃ³w
- ZMIANA: `src/mcp/MCPClient.js` â€” ACTION_TYPE_MAP + inline approval dla web_search
- ZMIANA: `src/views/chat_view.js` â€” inline approval block (renderowanie + obsÅ‚uga klikniÄ™Ä‡)
- ZMIANA: `src/core/WorkMode.js` â€” dodanie web_search do MODE_TOOLS
- ZMIANA: `src/core/PromptBuilder.js` â€” instrukcja DT w grupie szukanie

---

## FAZA B: ask_user Tool (sesja ~0.5, razem z A lub C)

### B1. Nowy plik: `src/mcp/AskUserTool.js`
- NarzÄ™dzie MCP: agent wywoÅ‚uje gdy chce zapytaÄ‡ usera o zdanie
- inputSchema:
  ```json
  {
    "question": "string â€” treÅ›Ä‡ pytania",
    "options": ["string[] â€” sugerowane odpowiedzi (opcjonalne)"],
    "context": "string â€” dlaczego pyta (opcjonalne)"
  }
  ```
- execute(): NIE wykonuje siÄ™ normalnie â€” zamiast tego sygnalizuje chat_view Å¼eby pokazaÅ‚ blok pytania

### B2. Inline question block w chacie
- Renderowany WEWNÄ„TRZ chatu (nie modal):
  ```
  â“ Agent pyta:
  "KtÃ³ry folder przeszukaÄ‡?"

  â—‹ Projekty/
  â—‹ Notatki/
  â—‹ CaÅ‚y vault
  [Wpisz wÅ‚asnÄ… odpowiedÅº...]

  [Odpowiedz]
  ```
- Klik na opcjÄ™ â†’ zaznacza
- Klik "Odpowiedz" â†’ zwraca wybranÄ… odpowiedÅº jako wynik tool calla
- Agent dostaje odpowiedÅº i kontynuuje
- YOLO mode â†’ automatycznie wybiera pierwszÄ… opcjÄ™

### B3. Rejestracja
- Rejestracja w main.js
- TOOL_INFO: `{ icon: 'â“', label: 'Pytanie do uÅ¼ytkownika' }`
- DostÄ™pne we WSZYSTKICH trybach pracy
- NIE wymaga approval (sam w sobie jest pytaniem)
- Decision Tree: instrukcja "Gdy nie jesteÅ› pewien intencji uÅ¼ytkownika, uÅ¼yj ask_user zamiast zgadywaÄ‡"

### Pliki do stworzenia/zmiany (Faza B):
- NOWY: `src/mcp/AskUserTool.js` (~50 LOC)
- ZMIANA: `src/main.js` â€” rejestracja
- ZMIANA: `src/views/chat_view.js` â€” renderowanie inline question block + obsÅ‚uga odpowiedzi
- ZMIANA: `src/components/ToolCallDisplay.js` â€” TOOL_INFO
- ZMIANA: `src/core/PromptBuilder.js` â€” instrukcja DT

---

## FAZA C: @ Mentions (sesja ~1)

### C1. Nowy plik: `src/components/MentionAutocomplete.js`
- Klasa podpinana do textarea w chat_view
- NasÅ‚uchuje na event `input` â€” wykrywa `@` w tekÅ›cie
- Pokazuje dropdown (absolutnie pozycjonowany div) pod/nad textarea
- Fuzzy search po nazwie pliku/folderu
- Nawigacja: strzaÅ‚ki gÃ³ra/dÃ³Å‚, Enter/Tab = wybierz, Escape = zamknij

### C2. Dwa typy mentions
- `@` + wpisywanie â†’ filtruje notatki z vaultu (app.vault.getMarkdownFiles())
- `@folder:` + wpisywanie â†’ filtruje foldery z vaultu
- Dropdown z kategoriÄ… (nagÅ‚Ã³wek "Notatki" / "Foldery") i ikonami
- Max 10 sugestii na raz

### C3. Resolving at send time
- Przy wysyÅ‚ce wiadomoÅ›ci (send_message):
  1. Wykryj @mention w tekÅ›cie (regex)
  2. Dla @note: czytaj treÅ›Ä‡ pliku via app.vault.read()
  3. Dla @folder: czytaj treÅ›Ä‡ plikÃ³w w folderze (max 5 plikÃ³w, z ostrzeÅ¼eniem)
  4. DoÅ‚Ä…cz treÅ›Ä‡ jako kontekst do wiadomoÅ›ci (przed tekstem usera)
  5. SprawdÅº AccessGuard â€” No-Go pliki/foldery ZABLOKOWANE
- W chacie: @mention wyÅ›wietlone jako klikalny chip (otwiera notatkÄ™ w Obsidianie)

### C4. Integracja z chat_view.js
- W handle_input_keydown(): gdy dropdown otwarty â†’ przechwytuj ArrowUp/Down/Enter/Escape
- Dropdown zamyka siÄ™ na blur (klik poza) z maÅ‚ym opÃ³Åºnieniem (200ms)
- Po wybraniu sugestii: wstawia `@NazwaNotatki` do textarea, zamyka dropdown

### Pliki do stworzenia/zmiany (Faza C):
- NOWY: `src/components/MentionAutocomplete.js` (~200 LOC)
- ZMIANA: `src/views/chat_view.js` â€” inicjalizacja MentionAutocomplete, _resolveMentions() w send_message
- ZMIANA: `src/views/chat_view.css` â€” style dropdowna, chipÃ³w @mention
- (Brak zmian w MCP/narzÄ™dziach â€” to feature UI, nie narzÄ™dzie agenta)

---

## FAZA D: ZaÅ‚Ä…czniki â€” obrazki, tekst, PDF (sesja ~1.5-2)

### D1. Nowy plik: `src/components/AttachmentManager.js`
- ZarzÄ…dza listÄ… pendingAttachments[]
- Metody:
  - addFile(file) â€” z systemu plikÃ³w (drag & drop, file picker)
  - addVaultFile(tFile) â€” z vault Obsidiana (drag z file explorera)
  - remove(id) â€” usuwa zaÅ‚Ä…cznik
  - clear() â€” czyÅ›ci po wysÅ‚aniu
  - buildContentBlocks(userText) â€” buduje tablicÄ™ content blocks dla API

### D2. ObsÅ‚ugiwane typy plikÃ³w
- **Obrazki** (png, jpg, gif, webp): base64 encode â†’ content block `image_url`
- **Tekst** (md, txt, js, ts, css, json, py, csv, log): czysty tekst â†’ doÅ‚Ä…czony przed wiadomoÅ›ciÄ…
- **PDF**: ekstrakcja tekstu via pdfjs-dist â†’ czysty tekst
  - Lazy-load biblioteki (dynamic import) â€” nie obciÄ…Å¼a bundla
  - Limit: max 50 stron (powyÅ¼ej â†’ ostrzeÅ¼enie + pierwsze 50)

### D3. Trzy wejÅ›cia do zaÅ‚Ä…czania
1. **Przycisk ğŸ“** obok send button â†’ natywny file picker (input type="file")
2. **Drag & drop** na obszar inputa â†’ event listeners dragover/drop na input_container
3. **Ctrl+V paste** obrazka z clipboard â†’ event listener paste na textarea

### D4. UI â€” chipy zaÅ‚Ä…cznikÃ³w
- Nowy div `.pkm-attachment-chips` MIÄ˜DZY skill buttons a textarea (w input_container)
- KaÅ¼dy zaÅ‚Ä…cznik = chip: [ikona typu] [nazwa pliku] [rozmiar] [X usuÅ„]
- Ukryty gdy brak zaÅ‚Ä…cznikÃ³w, widoczny gdy sÄ…
- Dla obrazkÃ³w: mini thumbnail (opcjonalnie, w v2)

### D5. Modyfikacja RollingWindow
- `addMessage()` musi akceptowaÄ‡ content jako string LUB tablicÄ™ content blocks
- `getMessagesForAPI()` musi przepuszczaÄ‡ tablicÄ™ bez konwersji na string
- WAÅ»NE: adaptery (Anthropic, OpenAI) JUÅ» obsÅ‚ugujÄ… tablice content blocks â€” zero zmian w adapterach!

### D6. Modyfikacja send_message()
- Po resolving @mentions:
  1. Pobierz content blocks z AttachmentManager.buildContentBlocks(text)
  2. JeÅ›li string â†’ normalna Å›cieÅ¼ka (bez zmian)
  3. JeÅ›li tablica â†’ dodaj do rolling window jako tablicÄ™
  4. WyczyÅ›Ä‡ zaÅ‚Ä…czniki po wysÅ‚aniu

### D7. Renderowanie w chacie
- WiadomoÅ›Ä‡ usera z zaÅ‚Ä…cznikami: chipy zaÅ‚Ä…cznikÃ³w wyÅ›wietlone w bÄ…belku usera
- Obrazki: miniatura (max 200px szerokoÅ›ci) klikalna (peÅ‚ny rozmiar)
- Pliki tekstowe: chip z nazwÄ… pliku
- PDF: chip z nazwÄ… + info "(X stron)"

### D8. Sprawdzenie kompatybilnoÅ›ci z modelami
- Vision (obrazki): Claude Sonnet/Opus âœ…, GPT-4o âœ…, Gemini âœ…, DeepSeek âŒ
- JeÅ›li model nie ma vision a user zaÅ‚Ä…cza obrazek â†’ Notice: "Ten model nie obsÅ‚uguje obrazkÃ³w. ZmieÅ„ model lub usuÅ„ zaÅ‚Ä…cznik."
- Sprawdzenie via adapter capabilities (do zbadania w kodzie adapterÃ³w)

### Pliki do stworzenia/zmiany (Faza D):
- NOWY: `src/components/AttachmentManager.js` (~200 LOC)
- ZMIANA: `src/memory/RollingWindow.js` â€” obsÅ‚uga content jako tablica
- ZMIANA: `src/views/chat_view.js` â€” przycisk ğŸ“, drag&drop, paste, chipy, modyfikacja send_message
- ZMIANA: `src/views/chat_view.css` â€” style chipÃ³w, drag-over, thumbnails
- ZMIANA: `src/main.js` â€” (ewentualnie) lazy-load pdfjs-dist
- ZMIANA: `src/components/ToolCallDisplay.js` â€” (ewentualnie) TOOL_INFO update

---

## KolejnoÅ›Ä‡ implementacji

```
Sesja 49:  Faza A (Web Search) + A5 (inline approval)
Sesja 50:  Faza B (ask_user) + Faza C (@ Mentions)
Sesja 51:  Faza D (ZaÅ‚Ä…czniki â€” tekst + obrazki)
Sesja 52:  Faza D kontynuacja (PDF + polish + testy)
```

Fazy B+C razem bo obie dotyczÄ… interakcji z inputem chatu i sÄ… mniejsze.
Faza D rozbita na 2 sesje bo wymaga zmian w RollingWindow + testowania z rÃ³Å¼nymi modelami.

---

## Wpis do PLAN_v2.md

Nowa sekcja `2.8.5 INPUT CHATU v2` z checkboxami:

```markdown
## 2.8.5 INPUT CHATU v2 â€” WEB SEARCH + @ MENTIONS + ZAÅÄ„CZNIKI

> **Cel:** Chat ma peÅ‚ne moÅ¼liwoÅ›ci: szukanie w necie, doÅ‚Ä…czanie notatek przez @, wrzucanie plikÃ³w/obrazkÃ³w.
> **Wymaga:** 2.8 (Skills v2 â€” gotowe)
> **Szacunek:** 4-5 sesji
> **Odniesienie:** BrakujÄ…ce core features, standard w AI chatach 2026

### 2.8.5a Web Search Tool
- [ ] WebSearchTool.js â€” narzÄ™dzie MCP (query â†’ wyniki)
- [ ] WebSearchProvider.js â€” multi-provider (Jina default, Tavily, Brave, SearXNG)
- [ ] Jina AI jako domyÅ›lny (dziaÅ‚a bez klucza API, za darmo)
- [ ] Ustawienia: wybÃ³r providera, klucz API, link do zaÅ‚oÅ¼enia konta
- [ ] Inline approval w chacie (nie popup modal) â€” blok z pytaniem "Szukaj? / Anuluj"
- [ ] YOLO mode: szuka bez pytania
- [ ] Renderowanie wynikÃ³w: tytuÅ‚y + linki + fragmenty (zwijany blok)
- [ ] Instrukcja w Decision Tree (grupa: szukanie)
- [ ] Rejestracja w ToolRegistry, WorkMode, ACTION_TYPE_MAP

### 2.8.5b ask_user Tool
- [ ] AskUserTool.js â€” narzÄ™dzie MCP (agent pyta usera, czeka na odpowiedÅº)
- [ ] Inline question block w chacie (opcje do klikniÄ™cia + pole wÅ‚asnej odpowiedzi)
- [ ] YOLO mode: auto-wybÃ³r pierwszej opcji
- [ ] Instrukcja w Decision Tree
- [ ] Rejestracja w ToolRegistry, WorkMode

### 2.8.5c @ Mentions
- [ ] MentionAutocomplete.js â€” dropdown autocomplete na @ w textarea
- [ ] @notatka â€” fuzzy search po plikach vaultu, doÅ‚Ä…czenie treÅ›ci przy wysyÅ‚ce
- [ ] @folder: â€” fuzzy search po folderach, doÅ‚Ä…czenie treÅ›ci plikÃ³w (max 5)
- [ ] Sprawdzenie AccessGuard (No-Go = zablokowane)
- [ ] Klikalne chipy @mention w bÄ…belku wiadomoÅ›ci
- [ ] Nawigacja klawiaturÄ… (strzaÅ‚ki, Enter, Escape)

### 2.8.5d ZaÅ‚Ä…czniki (pliki + obrazki + PDF)
- [ ] AttachmentManager.js â€” zarzÄ…dzanie pendingAttachments
- [ ] Przycisk ğŸ“ obok send button (file picker)
- [ ] Drag & drop plikÃ³w na input area
- [ ] Ctrl+V paste obrazka z clipboard
- [ ] Chipy zaÅ‚Ä…cznikÃ³w (nazwa + typ + rozmiar + X)
- [ ] ObsÅ‚uga obrazkÃ³w: base64 â†’ vision content blocks
- [ ] ObsÅ‚uga tekstu: (md/txt/js/json/csv) â†’ plain text w kontekÅ›cie
- [ ] ObsÅ‚uga PDF: pdfjs-dist lazy-load â†’ ekstrakcja tekstu
- [ ] Modyfikacja RollingWindow: content jako string LUB tablica
- [ ] Sprawdzenie vision capability modelu (brak â†’ Notice z ostrzeÅ¼eniem)
- [ ] Renderowanie w chacie: miniatura obrazka, chip pliku, chip PDF
```

---

## Ryzyka i uwagi

1. **Jina AI rate limit (3 RPM bez klucza)** â€” moÅ¼e byÄ‡ za wolne dla power userÃ³w. RozwiÄ…zanie: zachÄ™canie do zaÅ‚oÅ¼enia darmowego konta (100 RPM).

2. **pdfjs-dist zwiÄ™ksza bundle** (~700KB). RozwiÄ…zanie: lazy-load (dynamic import). Åaduje siÄ™ tylko gdy user wrzuca PDF.

3. **Vision nie dziaÅ‚a na DeepSeek** â€” user moÅ¼e byÄ‡ zdziwiony. RozwiÄ…zanie: jasne ostrzeÅ¼enie + sugestia modelu z vision.

4. **Inline approval vs ApprovalModal** â€” na razie inline TYLKO dla web_search. Reszta narzÄ™dzi dalej popup. Ujednolicenie to temat na 2.10 (UX Chatu).

5. **@ Mentions + duÅ¼e pliki** â€” user moÅ¼e doÅ‚Ä…czyÄ‡ 10MB notatkÄ™ przez @. RozwiÄ…zanie: limit tokenÃ³w per attachment + ostrzeÅ¼enie.
